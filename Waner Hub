-- WANER HUB v4.0 | COMPLETE WITH SMART KEYBIND DRAGGABLE TOGGLE
print("=== WENER HUB v4.0 ULTIMATE COMPLETE WITH SMART KEYBIND TOGGLE ===")
print("üöÄ Loading the most advanced Doors script with smart keybind detection...")

-- ============================================================================
-- SERVICES & INITIALIZATION
-- ============================================================================

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Lighting = game:GetService("Lighting")
local UserInputService = game:GetService("UserInputService")
local TeleportService = game:GetService("TeleportService")
local player = Players.LocalPlayer

-- Wait for character
repeat wait() until player.Character
repeat wait() until player.Character:FindFirstChild("HumanoidRootPart")

-- ============================================================================
-- VARIABLES UNTUK SEMUA FITUR
-- ============================================================================

local espObjects = {}
local currentSpeed = 16
local godModeEnabled = false
local noclipEnabled = false
local doorEspEnabled = false
local keyEspEnabled = false
local entityEspEnabled = false
local playerEspEnabled = false
local itemEspEnabled = false
local bookEspEnabled = false
local autoCollectEnabled = false
local autoUnlockEnabled = false
local infVitaminsEnabled = false
local rushNotifEnabled = false
local allEntityNotifications = false
local bypassAntiCheat = false

local noclipConnection
local autoCollectConnection
local autoUnlockConnection
local infVitaminsConnection
local entityConnections = {}
local godModeConnections = {}
local bypassConnections = {}

-- Smart Toggle Variables
local MainWindow = nil
local ToggleButton = nil
local isUIOpen = false
local currentKeybind = "K" -- Default keybind
local ToggleButtonInstance = nil
local KeybindBadgeText = nil

-- ============================================================================
-- SMART DRAGGABLE TOGGLE BUTTON WITH AUTO KEYBIND DETECTION
-- ============================================================================

local function updateButtonText()
    if ToggleButtonInstance then
        if isUIOpen then
            ToggleButtonInstance.Text = "CLOSE\n(" .. currentKeybind .. ")"
        else
            ToggleButtonInstance.Text = "OPEN\n(" .. currentKeybind .. ")"
        end
    end
end

local function updateKeybindBadge(newKeybind)
    if KeybindBadgeText then
        KeybindBadgeText.Text = newKeybind
    end
end

local function createSmartDraggableToggleButton()
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "WenerSmartToggleButton"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.Parent = game.CoreGui
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    
    local ToggleFrame = Instance.new("Frame")
    ToggleFrame.Name = "ToggleFrame"
    ToggleFrame.Size = UDim2.new(0, 95, 0, 95)
    ToggleFrame.Position = UDim2.new(0, 50, 0, 200)
    ToggleFrame.BackgroundColor3 = Color3.fromRGB(139, 0, 255)
    ToggleFrame.BorderSizePixel = 0
    ToggleFrame.ZIndex = 1000
    ToggleFrame.Parent = ScreenGui
    
    local Corner = Instance.new("UICorner")
    Corner.CornerRadius = UDim.new(1, 0) -- Perfect circle
    Corner.Parent = ToggleFrame
    
    local Gradient = Instance.new("UIGradient")
    Gradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(139, 0, 255)),
        ColorSequenceKeypoint.new(0.5, Color3.fromRGB(255, 0, 139)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(139, 0, 255))
    })
    Gradient.Rotation = 45
    Gradient.Parent = ToggleFrame
    
    local Stroke = Instance.new("UIStroke")
    Stroke.Color = Color3.fromRGB(255, 255, 255)
    Stroke.Thickness = 3
    Stroke.Transparency = 0.3
    Stroke.Parent = ToggleFrame
    
    local ToggleButtonMain = Instance.new("TextButton")
    ToggleButtonMain.Name = "ToggleButton"
    ToggleButtonMain.Size = UDim2.new(1, 0, 1, 0)
    ToggleButtonMain.BackgroundTransparency = 1
    ToggleButtonMain.Text = "OPEN\n(K)"
    ToggleButtonMain.TextColor3 = Color3.fromRGB(255, 255, 255)
    ToggleButtonMain.Font = Enum.Font.GothamBold
    ToggleButtonMain.TextSize = 13
    ToggleButtonMain.TextStrokeTransparency = 0
    ToggleButtonMain.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    ToggleButtonMain.ZIndex = 1001
    ToggleButtonMain.Parent = ToggleFrame
    
    ToggleButtonInstance = ToggleButtonMain
    
    -- Keybind Display Badge
    local KeybindBadge = Instance.new("Frame")
    KeybindBadge.Name = "KeybindBadge"
    KeybindBadge.Size = UDim2.new(0, 28, 0, 28)
    KeybindBadge.Position = UDim2.new(1, -33, 0, 5)
    KeybindBadge.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    KeybindBadge.BorderSizePixel = 0
    KeybindBadge.ZIndex = 1002
    KeybindBadge.Parent = ToggleFrame
    
    local BadgeCorner = Instance.new("UICorner")
    BadgeCorner.CornerRadius = UDim.new(1, 0)
    BadgeCorner.Parent = KeybindBadge
    
    local BadgeStroke = Instance.new("UIStroke")
    BadgeStroke.Color = Color3.fromRGB(139, 0, 255)
    BadgeStroke.Thickness = 2
    BadgeStroke.Transparency = 0
    BadgeStroke.Parent = KeybindBadge
    
    local KeybindText = Instance.new("TextLabel")
    KeybindText.Name = "KeybindText"
    KeybindText.Size = UDim2.new(1, 0, 1, 0)
    KeybindText.BackgroundTransparency = 1
    KeybindText.Text = currentKeybind
    KeybindText.TextColor3 = Color3.fromRGB(139, 0, 255)
    KeybindText.Font = Enum.Font.GothamBold
    KeybindText.TextSize = 16
    KeybindText.ZIndex = 1003
    KeybindText.Parent = KeybindBadge
    
    KeybindBadgeText = KeybindText
    
    -- Status Indicator
    local StatusIndicator = Instance.new("Frame")
    StatusIndicator.Name = "StatusIndicator"
    StatusIndicator.Size = UDim2.new(0, 12, 0, 12)
    StatusIndicator.Position = UDim2.new(0, 5, 0, 5)
    StatusIndicator.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
    StatusIndicator.BorderSizePixel = 0
    StatusIndicator.ZIndex = 1002
    StatusIndicator.Parent = ToggleFrame
    
    local StatusCorner = Instance.new("UICorner")
    StatusCorner.CornerRadius = UDim.new(1, 0)
    StatusCorner.Parent = StatusIndicator
    
    -- Dragging functionality
    local dragging = false
    local dragStart = nil
    local startPos = nil
    
    ToggleFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = ToggleFrame.Position
            
            TweenService:Create(ToggleFrame, TweenInfo.new(0.2), {
                Size = UDim2.new(0, 90, 0, 90)
            }):Play()
            TweenService:Create(Stroke, TweenInfo.new(0.2), {
                Thickness = 5,
                Transparency = 0
            }):Play()
        end
    end)
    
    ToggleFrame.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - dragStart
            ToggleFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
    
    ToggleFrame.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            if dragging then
                dragging = false
                
                TweenService:Create(ToggleFrame, TweenInfo.new(0.2), {
                    Size = UDim2.new(0, 95, 0, 95)
                }):Play()
                TweenService:Create(Stroke, TweenInfo.new(0.2), {
                    Thickness = 3,
                    Transparency = 0.3
                }):Play()
            end
        end
    end)
    
    -- Button click functionality with smart key simulation
    ToggleButtonMain.MouseButton1Click:Connect(function()
        if not dragging then -- Only toggle if not dragging
            isUIOpen = not isUIOpen
            
            -- Animate button
            TweenService:Create(ToggleFrame, TweenInfo.new(0.1), {
                Size = UDim2.new(0, 85, 0, 85)
            }):Play()
            
            task.wait(0.1)
            
            TweenService:Create(ToggleFrame, TweenInfo.new(0.1), {
                Size = UDim2.new(0, 95, 0, 95)
            }):Play()
            
            -- Update button appearance
            if isUIOpen then
                TweenService:Create(ToggleFrame, TweenInfo.new(0.3), {
                    BackgroundColor3 = Color3.fromRGB(255, 0, 0)
                }):Play()
                TweenService:Create(KeybindBadge, TweenInfo.new(0.3), {
                    BackgroundColor3 = Color3.fromRGB(255, 200, 200)
                }):Play()
                TweenService:Create(StatusIndicator, TweenInfo.new(0.3), {
                    BackgroundColor3 = Color3.fromRGB(255, 0, 0)
                }):Play()
            else
                TweenService:Create(ToggleFrame, TweenInfo.new(0.3), {
                    BackgroundColor3 = Color3.fromRGB(139, 0, 255)
                }):Play()
                TweenService:Create(KeybindBadge, TweenInfo.new(0.3), {
                    BackgroundColor3 = Color3.fromRGB(255, 255, 255)
                }):Play()
                TweenService:Create(StatusIndicator, TweenInfo.new(0.3), {
                    BackgroundColor3 = Color3.fromRGB(0, 255, 0)
                }):Play()
            end
            
            updateButtonText()
            
            -- Simulate current keybind press
            local keyCode = Enum.KeyCode[currentKeybind] or Enum.KeyCode.K
            game:GetService("VirtualInputManager"):SendKeyEvent(true, keyCode, false, game)
            task.wait(0.1)
            game:GetService("VirtualInputManager"):SendKeyEvent(false, keyCode, false, game)
            
            print("üéõÔ∏è Smart Toggle - Simulated key press: " .. currentKeybind)
        end
    end)
    
    -- Hover effects
    ToggleButtonMain.MouseEnter:Connect(function()
        if not dragging then
            TweenService:Create(ToggleFrame, TweenInfo.new(0.2), {
                Size = UDim2.new(0, 100, 0, 100)
            }):Play()
            TweenService:Create(Stroke, TweenInfo.new(0.2), {
                Transparency = 0
            }):Play()
        end
    end)
    
    ToggleButtonMain.MouseLeave:Connect(function()
        if not dragging then
            TweenService:Create(ToggleFrame, TweenInfo.new(0.2), {
                Size = UDim2.new(0, 95, 0, 95)
            }):Play()
            TweenService:Create(Stroke, TweenInfo.new(0.2), {
                Transparency = 0.3
            }):Play()
        end
    end)
    
    -- Pulsing animations
    task.spawn(function()
        while ScreenGui.Parent do
            TweenService:Create(Gradient, TweenInfo.new(2, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true), {
                Rotation = 405
            }):Play()
            
            TweenService:Create(KeybindBadge, TweenInfo.new(1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true), {
                Size = UDim2.new(0, 32, 0, 32)
            }):Play()
            
            TweenService:Create(StatusIndicator, TweenInfo.new(1, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true), {
                Size = UDim2.new(0, 15, 0, 15)
            }):Play()
            
            task.wait(1.5)
            
            TweenService:Create(KeybindBadge, TweenInfo.new(1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true), {
                Size = UDim2.new(0, 28, 0, 28)
            }):Play()
            
            TweenService:Create(StatusIndicator, TweenInfo.new(1, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true), {
                Size = UDim2.new(0, 12, 0, 12)
            }):Play()
            
            task.wait(1.5)
        end
    end)
    
    -- Function to update keybind from external source
    local function updateKeybind(newKeybind)
        currentKeybind = newKeybind
        updateKeybindBadge(newKeybind)
        updateButtonText()
        
        -- Animate keybind change
        TweenService:Create(KeybindBadge, TweenInfo.new(0.3), {
            BackgroundColor3 = Color3.fromRGB(0, 255, 0)
        }):Play()
        TweenService:Create(BadgeStroke, TweenInfo.new(0.3), {
            Color = Color3.fromRGB(0, 255, 0)
        }):Play()
        
        task.wait(1)
        
        TweenService:Create(KeybindBadge, TweenInfo.new(0.3), {
            BackgroundColor3 = Color3.fromRGB(255, 255, 255)
        }):Play()
        TweenService:Create(BadgeStroke, TweenInfo.new(0.3), {
            Color = Color3.fromRGB(139, 0, 255)
        }):Play()
        
        print("üîÑ Smart Toggle - Keybind updated to: " .. newKeybind)
    end
    
    ScreenGui.UpdateKeybind = updateKeybind
    
    return ScreenGui
end

-- ============================================================================
-- ADVANCED KEYBIND DETECTION SYSTEM
-- ============================================================================

local function setupSmartKeybindDetection()
    -- Monitor for Rayfield keybind changes with multiple detection methods
    task.spawn(function()
        local lastKeybind = currentKeybind
        local detectionAttempts = 0
        
        while true do
            task.wait(2) -- Check every 2 seconds
            detectionAttempts = detectionAttempts + 1
            
            -- Method 1: Try to detect from Rayfield UI elements
            pcall(function()
                local rayfield_ui = game.CoreGui:FindFirstChild("Rayfield")
                if rayfield_ui then
                    for _, obj in pairs(rayfield_ui:GetDescendants()) do
                        if obj:IsA("TextLabel") then
                            local text = obj.Text:upper()
                            
                            -- Look for keybind patterns in text
                            local possibleKeys = {"K", "E", "P", "M", "N", "B", "V", "X", "Z", "C", "F", "G", "H", "J", "L", "O", "Q", "R", "T", "U", "Y", "I"}
                            
                            for _, key in pairs(possibleKeys) do
                                if text:find("PRESS " .. key) or text:find("KEY: " .. key) or text:find("(" .. key .. ")") or text:find("[" .. key .. "]") then
                                    if key ~= currentKeybind then
                                        currentKeybind = key
                                        lastKeybind = key
                                        if ToggleButton and ToggleButton.UpdateKeybind then
                                            ToggleButton.UpdateKeybind(key)
                                        end
                                        print("üîç Auto-detected Rayfield keybind: " .. key)
                                    end
                                    return
                                end
                            end
                        end
                    end
                end
            end)
            
            -- Method 2: Monitor MainWindow properties
            pcall(function()
                if MainWindow and MainWindow.Keybind then
                    local newKeybind = tostring(MainWindow.Keybind):upper()
                    if newKeybind:len() == 1 and newKeybind ~= lastKeybind then
                        currentKeybind = newKeybind
                        lastKeybind = newKeybind
                        if ToggleButton and ToggleButton.UpdateKeybind then
                            ToggleButton.UpdateKeybind(newKeybind)
                        end
                        print("üîç Detected MainWindow keybind: " .. newKeybind)
                    end
                end
            end)
            
            -- Method 3: Check for common keybind storage in workspace
            if detectionAttempts % 5 == 0 then -- Every 10 seconds
                pcall(function()
                    local function checkForKeybindInStorage()
                        local possibleStorages = {game.ReplicatedStorage, workspace, game.StarterGui}
                        local possibleKeys = {"K", "E", "P", "M", "N", "B", "V", "X", "Z", "C", "F", "G", "H", "J", "L", "O"}
                        
                        for _, storage in pairs(possibleStorages) do
                            for _, obj in pairs(storage:GetDescendants()) do
                                if obj:IsA("StringValue") or obj:IsA("TextLabel") then
                                    if obj.Name:lower():find("keybind") or obj.Name:lower():find("toggle") then
                                        local value = obj:IsA("StringValue") and obj.Value or obj.Text
                                        value = tostring(value):upper()
                                        
                                        for _, key in pairs(possibleKeys) do
                                            if value == key and key ~= currentKeybind then
                                                currentKeybind = key
                                                if ToggleButton and ToggleButton.UpdateKeybind then
                                                    ToggleButton.UpdateKeybind(key)
                                                end
                                                print("üîç Found keybind in storage: " .. key)
                                                return true
                                            end
                                        end
                                    end
                                end
                            end
                        end
                        return false
                    end
                    
                    checkForKeybindInStorage()
                end)
            end
        end
    end)
    
    -- Also monitor key inputs to detect when UI toggles
    local lastToggleTime = 0
    local inputConnection
    inputConnection = UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        
        if input.UserInputType == Enum.UserInputType.Keyboard then
            local keyName = input.KeyCode.Name:upper()
            local currentTime = tick()
            
            -- Check if this key press might be toggling the UI
            if currentTime - lastToggleTime > 1 then -- Prevent spam detection
                task.wait(0.2) -- Small delay to detect UI state change
                
                -- If this is a valid keybind key and different from current
                local possibleKeys = {"K", "E", "P", "M", "N", "B", "V", "X", "Z", "C", "F", "G", "H", "J", "L", "O"}
                for _, key in pairs(possibleKeys) do
                    if keyName == key and key ~= currentKeybind then
                        -- Check if UI actually toggled by looking for Rayfield elements
                        pcall(function()
                            local rayfield = game.CoreGui:FindFirstChild("Rayfield")
                            if rayfield then
                                local isVisible = rayfield.Enabled
                                -- If we detect a state change, this might be the new keybind
                                currentKeybind = key
                                lastToggleTime = currentTime
                                if ToggleButton and ToggleButton.UpdateKeybind then
                                    ToggleButton.UpdateKeybind(key)
                                end
                                print("üîç Input-detected keybind: " .. key)
                            end
                        end)
                        break
                    end
                end
            end
        end
    end)
end

-- ============================================================================
-- AUTO EXECUTE & AUTO RECONNECT SETUP
-- ============================================================================

local function setupAutoExecute()
    local autoExecuteCode = [[
-- WANER HUB ULTIMATE AUTO EXECUTE WITH SMART KEYBIND
print("üöÄ WANER HUB Auto Execute Triggered!")
loadstring(game:HttpGet("https://raw.githubusercontent.com/WanerScripts/WenerHub/main/doors-ultimate-smart.lua"))()
]]
    
    if not isfolder("WenerHub") then
        makefolder("WenerHub")
    end
    
    writefile("WenerHub/AutoExecute.lua", autoExecuteCode)
    print("üöÄ Auto Execute: CONFIGURED")
end

local function setupAutoReconnect()
    local disconnectDetected = false
    
    local function createDisconnectGUI()
        local ScreenGui = Instance.new("ScreenGui")
        ScreenGui.Name = "WenerDisconnectGUI"
        ScreenGui.ResetOnSpawn = false
        ScreenGui.Parent = game.CoreGui
        
        local Blur = Instance.new("BlurEffect")
        Blur.Size = 30
        Blur.Parent = Lighting
        
        local Background = Instance.new("Frame")
        Background.Size = UDim2.new(1, 0, 1, 0)
        Background.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
        Background.BackgroundTransparency = 0.4
        Background.Parent = ScreenGui
        
        local DisconnectPanel = Instance.new("Frame")
        DisconnectPanel.Size = UDim2.new(0, 500, 0, 300)
        DisconnectPanel.Position = UDim2.new(0.5, -250, 0.5, -150)
        DisconnectPanel.BackgroundColor3 = Color3.fromRGB(15, 15, 25)
        DisconnectPanel.Parent = ScreenGui
        
        local Corner = Instance.new("UICorner")
        Corner.CornerRadius = UDim.new(0, 20)
        Corner.Parent = DisconnectPanel
        
        local Title = Instance.new("TextLabel")
        Title.Size = UDim2.new(1, 0, 0, 60)
        Title.BackgroundTransparency = 1
        Title.Text = "‚ö†Ô∏è CONNECTION LOST"
        Title.TextColor3 = Color3.fromRGB(255, 255, 255)
        Title.Font = Enum.Font.GothamBold
        Title.TextSize = 32
        Title.Parent = DisconnectPanel
        
        local Message = Instance.new("TextLabel")
        Message.Size = UDim2.new(1, -40, 0, 100)
        Message.Position = UDim2.new(0, 20, 0, 80)
        Message.BackgroundTransparency = 1
        Message.Text = "üîå Disconnected from server\nüì° Auto Reconnect in 5 seconds..."
        Message.TextColor3 = Color3.fromRGB(200, 200, 200)
        Message.Font = Enum.Font.Gotham
        Message.TextSize = 18
        Message.TextWrapped = true
        Message.Parent = DisconnectPanel
        
        local ReconnectBtn = Instance.new("TextButton")
        ReconnectBtn.Size = UDim2.new(0, 200, 0, 50)
        ReconnectBtn.Position = UDim2.new(0.5, -100, 0, 200)
        ReconnectBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
        ReconnectBtn.Text = "üîÑ Reconnect Now"
        ReconnectBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        ReconnectBtn.Font = Enum.Font.GothamBold
        ReconnectBtn.TextSize = 18
        ReconnectBtn.Parent = DisconnectPanel
        
        local BtnCorner = Instance.new("UICorner")
        BtnCorner.CornerRadius = UDim.new(0, 10)
        BtnCorner.Parent = ReconnectBtn
        
        local countdown = 5
        task.spawn(function()
            while countdown > 0 do
                Message.Text = string.format("üîå Disconnected from server\nüì° Auto Reconnect in %d seconds...", countdown)
                countdown = countdown - 1
                wait(1)
            end
            TeleportService:Teleport(game.PlaceId, player)
        end)
        
        ReconnectBtn.MouseButton1Click:Connect(function()
            TeleportService:Teleport(game.PlaceId, player)
        end)
    end
    
    local lastHeartbeat = tick()
    RunService.Heartbeat:Connect(function()
        lastHeartbeat = tick()
    end)
    
    task.spawn(function()
        while true do
            wait(1)
            if tick() - lastHeartbeat > 8 and not disconnectDetected then
                disconnectDetected = true
                createDisconnectGUI()
                break
            end
        end
    end)
end

setupAutoExecute()
setupAutoReconnect()

-- ============================================================================
-- LOADING SCREEN WITH SMART KEYBIND INFO
-- ============================================================================

local function createLoadingScreen()
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "WanerLoading"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.Parent = game.CoreGui
    
    local Blur = Instance.new("BlurEffect")
    Blur.Size = 0
    Blur.Parent = Lighting
    
    local Background = Instance.new("Frame")
    Background.Size = UDim2.new(1, 0, 1, 0)
    Background.BackgroundColor3 = Color3.fromRGB(5, 5, 10)
    Background.BackgroundTransparency = 1
    Background.Parent = ScreenGui
    
    local Container = Instance.new("Frame")
    Container.Size = UDim2.new(0, 700, 0, 450)
    Container.Position = UDim2.new(0.5, -350, 0.5, -225)
    Container.BackgroundColor3 = Color3.fromRGB(15, 15, 25)
    Container.BackgroundTransparency = 1
    Container.Parent = ScreenGui
    
    local Corner = Instance.new("UICorner")
    Corner.CornerRadius = UDim.new(0, 25)
    Corner.Parent = Container
    
    local Title = Instance.new("TextLabel")
    Title.Size = UDim2.new(1, 0, 0, 80)
    Title.Position = UDim2.new(0, 0, 0, 30)
    Title.BackgroundTransparency = 1
    Title.Text = "WENER HUB v4.0"
    Title.TextColor3 = Color3.fromRGB(255, 255, 255)
    Title.Font = Enum.Font.GothamBold
    Title.TextSize = 54
    Title.TextTransparency = 1
    Title.Parent = Container
    
    local Subtitle = Instance.new("TextLabel")
    Subtitle.Size = UDim2.new(1, 0, 0, 40)
    Subtitle.Position = UDim2.new(0, 0, 0, 110)
    Subtitle.BackgroundTransparency = 1
    Subtitle.Text = "COMPLETE WITH SMART KEYBIND DETECTION"
    Subtitle.TextColor3 = Color3.fromRGB(200, 200, 200)
    Subtitle.Font = Enum.Font.Gotham
    Subtitle.TextSize = 22
    Subtitle.TextTransparency = 1
    Subtitle.Parent = Container
    
    local FeatureInfo = Instance.new("TextLabel")
    FeatureInfo.Size = UDim2.new(1, -40, 0, 80)
    FeatureInfo.Position = UDim2.new(0, 20, 0, 160)
    FeatureInfo.BackgroundTransparency = 1
    FeatureInfo.Text = "üéõÔ∏è Smart draggable toggle with auto keybind detection\nüîç Button text updates based on Rayfield keybind (K), (E), (P), etc.\nüîÑ Real-time keybind monitoring and smart key simulation\n‚ôæÔ∏è Infinite clicks with multiple detection methods"
    FeatureInfo.TextColor3 = Color3.fromRGB(100, 200, 255)
    FeatureInfo.Font = Enum.Font.Gotham
    FeatureInfo.TextSize = 16
    FeatureInfo.TextWrapped = true
    FeatureInfo.TextTransparency = 1
    FeatureInfo.Parent = Container
    
    local Status = Instance.new("TextLabel")
    Status.Size = UDim2.new(1, 0, 0, 40)
    Status.Position = UDim2.new(0, 0, 0, 260)
    Status.BackgroundTransparency = 1
    Status.Text = "Initializing smart keybind detection algorithms..."
    Status.TextColor3 = Color3.fromRGB(100, 255, 100)
    Status.Font = Enum.Font.Gotham
    Status.TextSize = 18
    Status.TextTransparency = 1
    Status.Parent = Container
    
    local Progress = Instance.new("Frame")
    Progress.Size = UDim2.new(0, 0, 0, 8)
    Progress.Position = UDim2.new(0.075, 0, 0, 320)
    Progress.BackgroundColor3 = Color3.fromRGB(139, 0, 255)
    Progress.BorderSizePixel = 0
    Progress.BackgroundTransparency = 1
    Progress.Parent = Container
    
    local ProgressCorner = Instance.new("UICorner")
    ProgressCorner.CornerRadius = UDim.new(1, 0)
    ProgressCorner.Parent = Progress
    
    task.spawn(function()
        TweenService:Create(Blur, TweenInfo.new(1), {Size = 35}):Play()
        TweenService:Create(Background, TweenInfo.new(1), {BackgroundTransparency = 0.2}):Play()
        TweenService:Create(Container, TweenInfo.new(1), {BackgroundTransparency = 0.1}):Play()
        wait(1)
        
        TweenService:Create(Title, TweenInfo.new(0.8), {TextTransparency = 0}):Play()
        wait(0.4)
        TweenService:Create(Subtitle, TweenInfo.new(0.8), {TextTransparency = 0}):Play()
        wait(0.4)
        TweenService:Create(FeatureInfo, TweenInfo.new(0.8), {TextTransparency = 0}):Play()
        wait(0.4)
        TweenService:Create(Status, TweenInfo.new(0.8), {TextTransparency = 0}):Play()
        TweenService:Create(Progress, TweenInfo.new(0.8), {BackgroundTransparency = 0}):Play()
        wait(0.8)
        
        local stages = {
            {text = "üîß Setting up multi-method keybind detection...", progress = 0.15},
            {text = "üéõÔ∏è Creating smart draggable button with badges...", progress = 0.3},
            {text = "üîç Initializing real-time monitoring systems...", progress = 0.5},
            {text = "üëÅÔ∏è Loading complete ESP systems...", progress = 0.65},
            {text = "ü§ñ Configuring automation features...", progress = 0.8},
            {text = "‚ö° Finalizing smart toggle integration...", progress = 0.95},
            {text = "‚úÖ Smart keybind system ready!", progress = 1.0}
        }
        
        for _, stage in ipairs(stages) do
            Status.Text = stage.text
            TweenService:Create(Progress, TweenInfo.new(1), {Size = UDim2.new(0.85 * stage.progress, 0, 0, 8)}):Play()
            wait(1)
        end
        
        wait(1)
        
        TweenService:Create(Title, TweenInfo.new(0.8), {TextTransparency = 1}):Play()
        TweenService:Create(Subtitle, TweenInfo.new(0.8), {TextTransparency = 1}):Play()
        TweenService:Create(FeatureInfo, TweenInfo.new(0.8), {TextTransparency = 1}):Play()
        TweenService:Create(Status, TweenInfo.new(0.8), {TextTransparency = 1}):Play()
        TweenService:Create(Progress, TweenInfo.new(0.8), {BackgroundTransparency = 1}):Play()
        TweenService:Create(Container, TweenInfo.new(0.8), {BackgroundTransparency = 1}):Play()
        TweenService:Create(Background, TweenInfo.new(0.8), {BackgroundTransparency = 1}):Play()
        TweenService:Create(Blur, TweenInfo.new(1), {Size = 0}):Play()
        wait(1.2)
        
        Blur:Destroy()
        ScreenGui:Destroy()
    end)
end

createLoadingScreen()
wait(7)

-- ============================================================================
-- KEY SYSTEM WITH SMART KEYBIND INTEGRATION
-- ============================================================================

local KeySystemEnabled = true
local CorrectKey = "Wene-you"
local KeyExpireTime = 7200

local function checkKey()
    if not isfolder("WenerHub") then
        makefolder("WenerHub")
        return false
    end
    
    if not isfile("WenerHub/Key.json") then
        return false
    end
    
    local success, data = pcall(function()
        return game:GetService("HttpService"):JSONDecode(readfile("WenerHub/Key.json"))
    end)
    
    if not success or not data then return false end
    
    local currentTime = os.time()
    if data.key == CorrectKey and data.expire_time and currentTime < data.expire_time then
        return true
    end
    
    return false
end

local function saveKey()
    local currentTime = os.time()
    local expireTime = currentTime + KeyExpireTime
    
    local keyData = {
        key = CorrectKey,
        save_time = currentTime,
        expire_time = expireTime,
        user = player.Name,
        version = "v4.0_Smart_Keybind",
        keybind_default = currentKeybind
    }
    
    writefile("WenerHub/Key.json", game:GetService("HttpService"):JSONEncode(keyData))
end

local ownerUsername = "winnertupiq52"
local isOwner = player.Name == ownerUsername

if KeySystemEnabled and not checkKey() and not isOwner then
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "WanerKeySystem"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.Parent = game.CoreGui
    
    local Blur = Instance.new("BlurEffect")
    Blur.Size = 0
    Blur.Parent = Lighting
    
    local Background = Instance.new("Frame")
    Background.Size = UDim2.new(1, 0, 1, 0)
    Background.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    Background.BackgroundTransparency = 1
    Background.Parent = ScreenGui
    
    local MainFrame = Instance.new("Frame")
    MainFrame.Size = UDim2.new(0, 550, 0, 400)
    MainFrame.Position = UDim2.new(0.5, -275, 0.5, -200)
    MainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 25)
    MainFrame.BackgroundTransparency = 1
    MainFrame.Parent = ScreenGui
    
    local Corner = Instance.new("UICorner")
    Corner.CornerRadius = UDim.new(0, 25)
    Corner.Parent = MainFrame
    
    TweenService:Create(Blur, TweenInfo.new(0.8), {Size = 30}):Play()
    TweenService:Create(Background, TweenInfo.new(0.8), {BackgroundTransparency = 0.3}):Play()
    TweenService:Create(MainFrame, TweenInfo.new(0.8), {BackgroundTransparency = 0.1}):Play()
    wait(0.8)
    
    local Title = Instance.new("TextLabel")
    Title.Size = UDim2.new(1, 0, 0, 80)
    Title.BackgroundTransparency = 1
    Title.Text = "üîê WENER HUB KEY ACCESS"
    Title.TextColor3 = Color3.fromRGB(255, 255, 255)
    Title.Font = Enum.Font.GothamBold
    Title.TextSize = 32
    Title.Parent = MainFrame
    
    local SmartInfo = Instance.new("TextLabel")
    SmartInfo.Size = UDim2.new(1, -40, 0, 40)
    SmartInfo.Position = UDim2.new(0, 20, 0, 80)
    SmartInfo.BackgroundTransparency = 1
    SmartInfo.Text = "üéõÔ∏è Smart Keybind Detection: Auto-adapts to your Rayfield keybind!"
    SmartInfo.TextColor3 = Color3.fromRGB(100, 200, 255)
    SmartInfo.Font = Enum.Font.Gotham
    SmartInfo.TextSize = 16
    SmartInfo.Parent = MainFrame
    
    local ExpireInfo = Instance.new("TextLabel")
    ExpireInfo.Size = UDim2.new(1, -40, 0, 30)
    ExpireInfo.Position = UDim2.new(0, 20, 0, 125)
    ExpireInfo.BackgroundTransparency = 1
    ExpireInfo.Text = "‚è∞ Key valid for 2 hours after verification"
    ExpireInfo.TextColor3 = Color3.fromRGB(255, 165, 0)
    ExpireInfo.Font = Enum.Font.Gotham
    ExpireInfo.TextSize = 16
    ExpireInfo.Parent = MainFrame
    
    local KeyInput = Instance.new("TextBox")
    KeyInput.Size = UDim2.new(1, -40, 0, 60)
    KeyInput.Position = UDim2.new(0, 20, 0, 170)
    KeyInput.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
    KeyInput.PlaceholderText = "Enter Access Key: Wene-***"
    KeyInput.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
    KeyInput.Text = ""
    KeyInput.TextColor3 = Color3.fromRGB(255, 255, 255)
    KeyInput.Font = Enum.Font.Gotham
    KeyInput.TextSize = 22
    KeyInput.Parent = MainFrame
    
    local InputCorner = Instance.new("UICorner")
    InputCorner.CornerRadius = UDim.new(0, 15)
    InputCorner.Parent = KeyInput
    
    local SubmitBtn = Instance.new("TextButton")
    SubmitBtn.Size = UDim2.new(1, -40, 0, 60)
    SubmitBtn.Position = UDim2.new(0, 20, 0, 250)
    SubmitBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
    SubmitBtn.Text = "‚úì VERIFY KEY & ACTIVATE SMART TOGGLE"
    SubmitBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    SubmitBtn.Font = Enum.Font.GothamBold
    SubmitBtn.TextSize = 20
    SubmitBtn.Parent = MainFrame
    
    local BtnCorner = Instance.new("UICorner")
    BtnCorner.CornerRadius = UDim.new(0, 15)
    BtnCorner.Parent = SubmitBtn
    
    local Info = Instance.new("TextLabel")
    Info.Size = UDim2.new(1, -40, 0, 60)
    Info.Position = UDim2.new(0, 20, 0, 330)
    Info.BackgroundTransparency = 1
    Info.Text = "üîë Get key from Discord or contact owner\nüéõÔ∏è Smart Toggle: Auto-detects K, E, P, M and other keybinds\n‚ôæÔ∏è Infinite clicks with real-time keybind monitoring"
    Info.TextColor3 = Color3.fromRGB(200, 200, 200)
    Info.Font = Enum.Font.Gotham
    Info.TextSize = 14
    Info.TextWrapped = true
    Info.Parent = MainFrame
    
    local submitted = false
    SubmitBtn.MouseButton1Click:Connect(function()
        if KeyInput.Text == CorrectKey then
            saveKey()
            submitted = true
            
            SubmitBtn.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
            SubmitBtn.Text = "‚úÖ SUCCESS! Smart Toggle Activated!"
            
            wait(1.5)
            
            TweenService:Create(MainFrame, TweenInfo.new(0.8), {BackgroundTransparency = 1}):Play()
            TweenService:Create(Title, TweenInfo.new(0.8), {TextTransparency = 1}):Play()
            TweenService:Create(SmartInfo, TweenInfo.new(0.8), {TextTransparency = 1}):Play()
            TweenService:Create(ExpireInfo, TweenInfo.new(0.8), {TextTransparency = 1}):Play()
            TweenService:Create(KeyInput, TweenInfo.new(0.8), {BackgroundTransparency = 1, TextTransparency = 1}):Play()
            TweenService:Create(SubmitBtn, TweenInfo.new(0.8), {BackgroundTransparency = 1, TextTransparency = 1}):Play()
            TweenService:Create(Info, TweenInfo.new(0.8), {TextTransparency = 1}):Play()
            TweenService:Create(Background, TweenInfo.new(0.8), {BackgroundTransparency = 1}):Play()
            TweenService:Create(Blur, TweenInfo.new(1), {Size = 0}):Play()
            wait(1.2)
            
            Blur:Destroy()
            ScreenGui:Destroy()
        else
            SubmitBtn.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
            SubmitBtn.Text = "‚ùå INVALID KEY"
            wait(1.5)
            SubmitBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
            SubmitBtn.Text = "‚úì VERIFY KEY & ACTIVATE SMART TOGGLE"
        end
    end)
    
    repeat wait(0.1) until submitted
end

-- ============================================================================
-- WELCOME SCREEN WITH KEYBIND INFO
-- ============================================================================

local function createWelcomeScreen()
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "WenerWelcome"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.Parent = game.CoreGui
    
    local Blur = Instance.new("BlurEffect")
    Blur.Size = 0
    Blur.Parent = Lighting
    
    local Background = Instance.new("Frame")
    Background.Size = UDim2.new(1, 0, 1, 0)
    Background.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    Background.BackgroundTransparency = 1
    Background.Parent = ScreenGui
    
    local WelcomeText = Instance.new("TextLabel")
    WelcomeText.Size = UDim2.new(0.9, 0, 0.15, 0)
    WelcomeText.Position = UDim2.new(0.05, 0, 0.25, 0)
    WelcomeText.BackgroundTransparency = 1
    WelcomeText.Text = "Welcome " .. player.DisplayName .. " To WENER Hub"
    WelcomeText.TextColor3 = Color3.fromRGB(139, 0, 255)
    WelcomeText.Font = Enum.Font.GothamBold
    WelcomeText.TextSize = 48
    WelcomeText.TextStrokeTransparency = 0
    WelcomeText.TextTransparency = 1
    WelcomeText.TextScaled = true
    WelcomeText.Parent = ScreenGui
    
    local HubText = Instance.new("TextLabel")
    HubText.Size = UDim2.new(1, 0, 0.2, 0)
    HubText.Position = UDim2.new(0, 0, 0.45, 0)
    HubText.BackgroundTransparency = 1
    HubText.Text = "Smart Keybind Toggle"
    HubText.TextColor3 = Color3.fromRGB(255, 255, 255)
    HubText.Font = Enum.Font.GothamBold
    HubText.TextSize = 64
    HubText.TextStrokeTransparency = 0
    HubText.TextTransparency = 1
    HubText.Parent = ScreenGui
    
    local KeybindInfo = Instance.new("TextLabel")
    KeybindInfo.Size = UDim2.new(0.8, 0, 0.1, 0)
    KeybindInfo.Position = UDim2.new(0.1, 0, 0.7, 0)
    KeybindInfo.BackgroundTransparency = 1
    KeybindInfo.Text = "üéõÔ∏è Button auto-detects your keybind: (K), (E), (P), etc."
    KeybindInfo.TextColor3 = Color3.fromRGB(100, 200, 255)
    KeybindInfo.Font = Enum.Font.Gotham
        KeybindInfo.TextSize = 24
    KeybindInfo.TextStrokeTransparency = 0
    KeybindInfo.TextTransparency = 1
    KeybindInfo.TextScaled = true
    KeybindInfo.Parent = ScreenGui
    
    task.spawn(function()
        TweenService:Create(Blur, TweenInfo.new(1), {Size = 25}):Play()
        TweenService:Create(Background, TweenInfo.new(1), {BackgroundTransparency = 0.4}):Play()
        wait(1)
        
        TweenService:Create(WelcomeText, TweenInfo.new(1.5), {TextTransparency = 0}):Play()
        wait(1)
        TweenService:Create(HubText, TweenInfo.new(1.5), {TextTransparency = 0}):Play()
        wait(1)
        TweenService:Create(KeybindInfo, TweenInfo.new(1.5), {TextTransparency = 0}):Play()
        wait(3)
        
        TweenService:Create(WelcomeText, TweenInfo.new(1), {TextTransparency = 1}):Play()
        TweenService:Create(HubText, TweenInfo.new(1), {TextTransparency = 1}):Play()
        TweenService:Create(KeybindInfo, TweenInfo.new(1), {TextTransparency = 1}):Play()
        TweenService:Create(Background, TweenInfo.new(1), {BackgroundTransparency = 1}):Play()
        TweenService:Create(Blur, TweenInfo.new(1.5), {Size = 0}):Play()
        wait(2)
        
        Blur:Destroy()
        ScreenGui:Destroy()
    end)
end

createWelcomeScreen()
wait(7)

-- ============================================================================
-- PERMANENT LOGO SYSTEM
-- ============================================================================

local function createPermanentLogo()
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "WenerPermanentLogo"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.Parent = game.CoreGui
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    
    local LogoFrame = Instance.new("Frame")
    LogoFrame.Name = "LogoFrame"
    LogoFrame.Size = UDim2.new(0, 200, 0, 60)
    LogoFrame.Position = UDim2.new(1, -210, 0, 10)
    LogoFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 25)
    LogoFrame.BackgroundTransparency = 0.1
    LogoFrame.BorderSizePixel = 0
    LogoFrame.ZIndex = 999
    LogoFrame.Parent = ScreenGui
    
    local Corner = Instance.new("UICorner")
    Corner.CornerRadius = UDim.new(0, 12)
    Corner.Parent = LogoFrame
    
    local Stroke = Instance.new("UIStroke")
    Stroke.Color = Color3.fromRGB(139, 0, 255)
    Stroke.Thickness = 2
    Stroke.Transparency = 0.3
    Stroke.Parent = LogoFrame
    
    local Gradient = Instance.new("UIGradient")
    Gradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(139, 0, 255)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 0, 139))
    })
    Gradient.Rotation = 45
    Gradient.Parent = LogoFrame
    
    local MainText = Instance.new("TextLabel")
    MainText.Size = UDim2.new(0.75, 0, 0.6, 0)
    MainText.Position = UDim2.new(0.05, 0, 0.1, 0)
    MainText.BackgroundTransparency = 1
    MainText.Text = "WENER HUB v4.0"
    MainText.TextColor3 = Color3.fromRGB(255, 255, 255)
    MainText.Font = Enum.Font.GothamBold
    MainText.TextSize = 16
    MainText.TextStrokeTransparency = 0
    MainText.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    MainText.ZIndex = 1000
    MainText.Parent = LogoFrame
    
    local SubText = Instance.new("TextLabel")
    SubText.Size = UDim2.new(0.75, 0, 0.3, 0)
    SubText.Position = UDim2.new(0.05, 0, 0.65, 0)
    SubText.BackgroundTransparency = 1
    SubText.Text = "Smart Keybind: " .. currentKeybind
    SubText.TextColor3 = Color3.fromRGB(200, 200, 200)
    SubText.Font = Enum.Font.Gotham
    SubText.TextSize = 12
    SubText.TextStrokeTransparency = 0
    SubText.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    SubText.ZIndex = 1000
    SubText.Parent = LogoFrame
    
    local StatusIcon = Instance.new("Frame")
    StatusIcon.Size = UDim2.new(0, 12, 0, 12)
    StatusIcon.Position = UDim2.new(0.85, 0, 0.2, 0)
    StatusIcon.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
    StatusIcon.BorderSizePixel = 0
    StatusIcon.ZIndex = 1000
    StatusIcon.Parent = LogoFrame
    
    local IconCorner = Instance.new("UICorner")
    IconCorner.CornerRadius = UDim.new(1, 0)
    IconCorner.Parent = StatusIcon
    
    local OwnerIcon = nil
    if isOwner then
        OwnerIcon = Instance.new("TextLabel")
        OwnerIcon.Size = UDim2.new(0, 16, 0, 16)
        OwnerIcon.Position = UDim2.new(0.85, 0, 0.6, 0)
        OwnerIcon.BackgroundTransparency = 1
        OwnerIcon.Text = "üëë"
        OwnerIcon.TextColor3 = Color3.fromRGB(255, 215, 0)
        OwnerIcon.Font = Enum.Font.Gotham
        OwnerIcon.TextSize = 14
        OwnerIcon.ZIndex = 1001
        OwnerIcon.Parent = LogoFrame
    end
    
    -- Function to update keybind display
    local function updateLogoKeybind(newKeybind)
        SubText.Text = "Smart Keybind: " .. newKeybind
    end
    
    ScreenGui.UpdateKeybind = updateLogoKeybind
    
    -- Pulsing animation
    task.spawn(function()
        while ScreenGui.Parent do
            TweenService:Create(Gradient, TweenInfo.new(2, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true), {
                Rotation = 405
            }):Play()
            
            TweenService:Create(StatusIcon, TweenInfo.new(1, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true), {
                Size = UDim2.new(0, 15, 0, 15)
            }):Play()
            
            if OwnerIcon then
                TweenService:Create(OwnerIcon, TweenInfo.new(1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true), {
                    TextTransparency = 0.3
                }):Play()
            end
            
            task.wait(2)
            
            TweenService:Create(StatusIcon, TweenInfo.new(1, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true), {
                Size = UDim2.new(0, 12, 0, 12)
            }):Play()
            
            if OwnerIcon then
                TweenService:Create(OwnerIcon, TweenInfo.new(1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true), {
                    TextTransparency = 0
                }):Play()
            end
            
            task.wait(2)
        end
    end)
    
    return ScreenGui
end

local PermanentLogo = createPermanentLogo()

-- ============================================================================
-- ADVANCED ESP SYSTEM WITH FIXED SIZE
-- ============================================================================

local function createFixedESP(part, text, color, espType)
    if not part or part:FindFirstChild("WenerESP_" .. espType) then return end
    
    local highlight = Instance.new("Highlight")
    highlight.Name = "WenerESP_" .. espType
    highlight.Adornee = part
    highlight.FillColor = color
    highlight.FillTransparency = 0.7
    highlight.OutlineColor = color
    highlight.OutlineTransparency = 0
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Parent = part
    
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "WenerESP_" .. espType .. "_Bill"
    billboard.Adornee = part
    billboard.Size = UDim2.new(0, 200, 0, 80)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = part
    
    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 0.5, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.Text = text
    textLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    textLabel.Font = Enum.Font.GothamBold
    textLabel.TextSize = 18
    textLabel.TextStrokeTransparency = 0
    textLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    textLabel.Parent = billboard
    
    local distanceLabel = Instance.new("TextLabel")
    distanceLabel.Size = UDim2.new(1, 0, 0.5, 0)
    distanceLabel.Position = UDim2.new(0, 0, 0.5, 0)
    distanceLabel.BackgroundTransparency = 1
    distanceLabel.Text = "0 studs"
    distanceLabel.TextColor3 = color
    distanceLabel.Font = Enum.Font.Gotham
    distanceLabel.TextSize = 14
    distanceLabel.TextStrokeTransparency = 0
    distanceLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    distanceLabel.Parent = billboard
    
    local espData = {
        part = part,
        highlight = highlight,
        billboard = billboard,
        textLabel = textLabel,
        distanceLabel = distanceLabel,
        espType = espType
    }
    
    table.insert(espObjects, espData)
    
    task.spawn(function()
        while highlight.Parent and billboard.Parent and player.Character and player.Character:FindFirstChild("HumanoidRootPart") do
            local distance = (player.Character.HumanoidRootPart.Position - part.Position).Magnitude
            distanceLabel.Text = math.floor(distance) .. " studs"
            
            if distance > 500 then
                highlight:Destroy()
                billboard:Destroy()
                break
            end
            
            wait(0.5)
        end
        
        for i, data in pairs(espObjects) do
            if data == espData then
                table.remove(espObjects, i)
                break
            end
        end
    end)
end

local function updateDoorESP()
    if not doorEspEnabled then return end
    
    local currentRooms = workspace:FindFirstChild("CurrentRooms")
    if not currentRooms then return end
    
    for _, room in pairs(currentRooms:GetChildren()) do
        if room:IsA("Model") and tonumber(room.Name) then
            local door = room:FindFirstChild("Door")
            if door then
                local doorPart = door:FindFirstChild("Door") or door:FindFirstChildWhichIsA("BasePart")
                if doorPart and not doorPart:FindFirstChild("WenerESP_door") then
                    createFixedESP(doorPart, "üö™ Room " .. room.Name, Color3.fromRGB(0, 255, 0), "door")
                end
            end
        end
    end
end

local function updateKeyESP()
    if not keyEspEnabled then return end
    
    local keyNames = {"Key", "LibraryHintPaper", "Paper"}
    
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Model") then
            local isKey = false
            local keyName = "Key"
            
            for _, name in pairs(keyNames) do
                if obj.Name == name or obj.Name:find(name) then
                    isKey = true
                    keyName = name
                    break
                end
            end
            
            if isKey then
                local keyPart = obj:FindFirstChildWhichIsA("BasePart")
                if keyPart then
                    local prompt = keyPart:FindFirstChildOfClass("ProximityPrompt")
                    if prompt and not keyPart:FindFirstChild("WenerESP_key") then
                        createFixedESP(keyPart, "üóùÔ∏è " .. keyName, Color3.fromRGB(255, 255, 0), "key")
                    end
                end
            end
        end
    end
end

local function updateItemESP()
    if not itemEspEnabled then return end
    
    local collectableItems = {
        "Vitamins", "Lockpick", "Flashlight", "Lighter", 
        "Candle", "Crucifix", "Bandage", "SkeletonKey"
    }
    
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Model") then
            for _, itemName in pairs(collectableItems) do
                if obj.Name == itemName or obj.Name:find(itemName) then
                    local itemPart = obj:FindFirstChildWhichIsA("BasePart")
                    if itemPart then
                        local prompt = itemPart:FindFirstChildOfClass("ProximityPrompt")
                        if prompt and not itemPart:FindFirstChild("WenerESP_item") then
                            createFixedESP(itemPart, "üì¶ " .. itemName, Color3.fromRGB(255, 0, 0), "item")
                        end
                    end
                end
            end
        end
    end
end

local function updateBookESP()
    if not bookEspEnabled then return end
    
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Model") and (obj.Name == "Book" or obj.Name:find("Book")) then
            local bookPart = obj:FindFirstChild("Book") or obj:FindFirstChildWhichIsA("BasePart")
            if bookPart then
                local prompt = bookPart:FindFirstChildOfClass("ProximityPrompt")
                if prompt and not bookPart:FindFirstChild("WenerESP_book") then
                    createFixedESP(bookPart, "üìö Figure Book", Color3.fromRGB(139, 69, 19), "book")
                end
            end
        end
    end
end

local function updateEntityESP()
    if not entityEspEnabled then return end
    
    local entities = {
        {name = "RushMoving", displayName = "Rush", color = Color3.fromRGB(255, 0, 0)},
        {name = "AmbushMoving", displayName = "Ambush", color = Color3.fromRGB(255, 100, 0)},
        {name = "Eyes", displayName = "Eyes", color = Color3.fromRGB(255, 255, 255)},
        {name = "Screech", displayName = "Screech", color = Color3.fromRGB(0, 255, 0)},
        {name = "Halt", displayName = "Halt", color = Color3.fromRGB(0, 0, 255)},
        {name = "Seek", displayName = "Seek", color = Color3.fromRGB(0, 0, 0)},
        {name = "Figure", displayName = "Figure", color = Color3.fromRGB(139, 0, 255)},
        {name = "Dupe", displayName = "Dupe", color = Color3.fromRGB(255, 255, 0)},
        {name = "A60", displayName = "A-60", color = Color3.fromRGB(255, 0, 255)},
        {name = "A120", displayName = "A-120", color = Color3.fromRGB(0, 255, 255)},
        {name = "Timothy", displayName = "Timothy", color = Color3.fromRGB(128, 0, 128)},
        {name = "Shadow", displayName = "Shadow", color = Color3.fromRGB(64, 64, 64)}
    }
    
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Model") then
            for _, entityData in pairs(entities) do
                if obj.Name == entityData.name or obj.Name:find(entityData.name) then
                    local entityPart = obj:FindFirstChild("Base") or obj:FindFirstChildWhichIsA("BasePart")
                    if entityPart and not entityPart:FindFirstChild("WenerESP_entity") then
                        createFixedESP(entityPart, "üëπ " .. entityData.displayName, entityData.color, "entity")
                    end
                end
            end
        end
    end
end

local function updatePlayerESP()
    if not playerEspEnabled then return end
    
    for _, otherPlayer in pairs(Players:GetPlayers()) do
        if otherPlayer ~= player and otherPlayer.Character and otherPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local humanoidRootPart = otherPlayer.Character.HumanoidRootPart
            if not humanoidRootPart:FindFirstChild("WenerESP_player") then
                createFixedESP(humanoidRootPart, "üë§ " .. otherPlayer.DisplayName, Color3.fromRGB(0, 255, 255), "player")
            end
        end
    end
end

local function clearAllESP()
    for _, espData in pairs(espObjects) do
        if espData.highlight and espData.highlight.Parent then
            espData.highlight:Destroy()
        end
        if espData.billboard and espData.billboard.Parent then
            espData.billboard:Destroy()
        end
    end
    espObjects = {}
    
    for _, obj in pairs(workspace:GetDescendants()) do
        local highlight = obj:FindFirstChild("WenerESP_door") or obj:FindFirstChild("WenerESP_key") or 
                         obj:FindFirstChild("WenerESP_entity") or obj:FindFirstChild("WenerESP_player") or
                         obj:FindFirstChild("WenerESP_book") or obj:FindFirstChild("WenerESP_item")
        local billboard = obj:FindFirstChild("WenerESP_door_Bill") or obj:FindFirstChild("WenerESP_key_Bill") or 
                         obj:FindFirstChild("WenerESP_entity_Bill") or obj:FindFirstChild("WenerESP_player_Bill") or
                         obj:FindFirstChild("WenerESP_book_Bill") or obj:FindFirstChild("WenerESP_item_Bill")
        
        if highlight then highlight:Destroy() end
        if billboard then billboard:Destroy() end
    end
end

-- ============================================================================
-- ADVANCED NOTIFICATION SYSTEM
-- ============================================================================

local function createAdvancedNotification(title, message, color, duration, sound)
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "WenerNotification"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.Parent = game.CoreGui
    
    local NotificationFrame = Instance.new("Frame")
    NotificationFrame.Size = UDim2.new(0, 450, 0, 130)
    NotificationFrame.Position = UDim2.new(1, 20, 0, 100)
    NotificationFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 25)
    NotificationFrame.BorderSizePixel = 0
    NotificationFrame.Parent = ScreenGui
    
    local Corner = Instance.new("UICorner")
    Corner.CornerRadius = UDim.new(0, 15)
    Corner.Parent = NotificationFrame
    
    local Gradient = Instance.new("UIGradient")
    Gradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, color),
        ColorSequenceKeypoint.new(1, Color3.new(color.R * 0.5, color.G * 0.5, color.B * 0.5))
    })
    Gradient.Rotation = 45
    Gradient.Parent = NotificationFrame
    
    local TitleLabel = Instance.new("TextLabel")
    TitleLabel.Size = UDim2.new(1, -20, 0, 40)
    TitleLabel.Position = UDim2.new(0, 10, 0, 10)
    TitleLabel.BackgroundTransparency = 1
    TitleLabel.Text = title
    TitleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    TitleLabel.Font = Enum.Font.GothamBold
    TitleLabel.TextSize = 20
    TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
    TitleLabel.Parent = NotificationFrame
    
    local MessageLabel = Instance.new("TextLabel")
    MessageLabel.Size = UDim2.new(1, -20, 0, 70)
    MessageLabel.Position = UDim2.new(0, 10, 0, 50)
    MessageLabel.BackgroundTransparency = 1
    MessageLabel.Text = message
    MessageLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    MessageLabel.Font = Enum.Font.Gotham
    MessageLabel.TextSize = 16
    MessageLabel.TextWrapped = true
    MessageLabel.TextXAlignment = Enum.TextXAlignment.Left
    MessageLabel.TextYAlignment = Enum.TextYAlignment.Top
    MessageLabel.Parent = NotificationFrame
    
    if sound then
        local soundEffect = Instance.new("Sound")
        soundEffect.SoundId = "rbxassetid://131961136"
        soundEffect.Volume = 0.5
        soundEffect.Parent = ScreenGui
        soundEffect:Play()
        
        soundEffect.Ended:Connect(function()
            soundEffect:Destroy()
        end)
    end
    
    TweenService:Create(NotificationFrame, TweenInfo.new(0.5, Enum.EasingStyle.Back), {
        Position = UDim2.new(1, -470, 0, 100)
    }):Play()
    
    task.spawn(function()
        task.wait(duration or 5)
        
        TweenService:Create(NotificationFrame, TweenInfo.new(0.5, Enum.EasingStyle.Quad), {
            Position = UDim2.new(1, 20, 0, 100),
            BackgroundTransparency = 1
        }):Play()
        
        TweenService:Create(TitleLabel, TweenInfo.new(0.5), {TextTransparency = 1}):Play()
        TweenService:Create(MessageLabel, TweenInfo.new(0.5), {TextTransparency = 1}):Play()
        
        task.wait(0.5)
        ScreenGui:Destroy()
    end)
end

-- ============================================================================
-- ENTITY DETECTION & NOTIFICATION SYSTEM
-- ============================================================================

local lastEntityNotification = {}

local function setupEntityNotifications()
    for _, conn in pairs(entityConnections) do
        pcall(function() conn:Disconnect() end)
    end
    entityConnections = {}
    
    if not rushNotifEnabled and not allEntityNotifications then return end
    
    local entities = {
        {name = "RushMoving", displayName = "Rush", color = Color3.fromRGB(255, 0, 0), message = "Rush is coming! Hide immediately!"},
        {name = "AmbushMoving", displayName = "Ambush", color = Color3.fromRGB(255, 100, 0), message = "Ambush detected! Get ready to hide multiple times!"},
        {name = "Eyes", displayName = "Eyes", color = Color3.fromRGB(255, 255, 255), message = "Eyes appeared! Don't look at them!"},
        {name = "Screech", displayName = "Screech", color = Color3.fromRGB(0, 255, 0), message = "Screech is near! Turn around when you hear the sound!"},
        {name = "Halt", displayName = "Halt", color = Color3.fromRGB(0, 0, 255), message = "Halt appeared! Stop moving when the screen turns blue!"},
        {name = "Seek", displayName = "Seek", color = Color3.fromRGB(0, 0, 0), message = "Seek chase sequence! Run and avoid obstacles!"},
        {name = "Figure", displayName = "Figure", color = Color3.fromRGB(139, 0, 255), message = "Figure is in the library! Move quietly and avoid making noise!"},
        {name = "Dupe", displayName = "Dupe", color = Color3.fromRGB(255, 255, 0), message = "Dupe detected! Check door numbers carefully!"},
        {name = "A60", displayName = "A-60", color = Color3.fromRGB(255, 0, 255), message = "A-60 is coming! Hide in a locker immediately!"},
        {name = "A120", displayName = "A-120", color = Color3.fromRGB(0, 255, 255), message = "A-120 detected! Find a hiding spot quickly!"}
    }
    
    local function onEntityAdded(entity)
        for _, entityData in pairs(entities) do
            if entity.Name == entityData.name or entity.Name:find(entityData.name) then
                local currentTime = tick()
                
                if lastEntityNotification[entityData.name] and currentTime - lastEntityNotification[entityData.name] < 3 then
                    return
                end
                lastEntityNotification[entityData.name] = currentTime
                
                local shouldNotify = false
                if allEntityNotifications then
                    shouldNotify = true
                elseif rushNotifEnabled and (entityData.name == "RushMoving" or entityData.name == "AmbushMoving") then
                    shouldNotify = true
                end
                
                if shouldNotify then
                    createAdvancedNotification(
                        "‚ö†Ô∏è ENTITY DETECTED: " .. entityData.displayName,
                        entityData.message,
                        entityData.color,
                        6,
                        true
                    )
                    
                    print("üö® Entity Alert: " .. entityData.displayName .. " detected!")
                end
                break
            end
        end
    end
    
    local conn = workspace.DescendantAdded:Connect(function(descendant)
        if descendant:IsA("Model") then
            task.wait(0.1)
            onEntityAdded(descendant)
        end
    end)
    
    table.insert(entityConnections, conn)
end

-- ============================================================================
-- AUTO COLLECT SYSTEM
-- ============================================================================

local autoCollectSettings = {
    ["Vitamins"] = true,
    ["Lockpick"] = true,
    ["Key"] = true,
    ["Flashlight"] = true,
    ["Lighter"] = true,
    ["Candle"] = true,
    ["Crucifix"] = true,
    ["Bandage"] = true,
    ["SkeletonKey"] = true,
    ["Book"] = true
}

local function enableAutoCollect()
    autoCollectEnabled = true
    
    if autoCollectConnection then autoCollectConnection:Disconnect() end
    
    local function collectItems()
        if not autoCollectEnabled or not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return end
        
        for _, obj in pairs(workspace:GetDescendants()) do
            if obj:IsA("Model") then
                local shouldCollect = false
                
                for itemName, enabled in pairs(autoCollectSettings) do
                    if enabled and (obj.Name == itemName or obj.Name:find(itemName)) then
                        shouldCollect = true
                        break
                    end
                end
                
                if shouldCollect then
                    local itemPart = obj:FindFirstChildWhichIsA("BasePart")
                    if itemPart then
                        local distance = (player.Character.HumanoidRootPart.Position - itemPart.Position).Magnitude
                        if distance <= 15 then
                            local prompt = itemPart:FindFirstChildOfClass("ProximityPrompt")
                            if prompt and prompt.Enabled then
                                pcall(function()
                                    fireproximityprompt(prompt)
                                end)
                            end
                        end
                    end
                end
            end
        end
    end
    
    autoCollectConnection = RunService.Heartbeat:Connect(function()
        collectItems()
    end)
    
    print("üì¶ Advanced Auto Collect: ENABLED")
end

local function disableAutoCollect()
    autoCollectEnabled = false
    
    if autoCollectConnection then autoCollectConnection:Disconnect() end
    
    print("üì¶ Advanced Auto Collect: DISABLED")
end

-- ============================================================================
-- AUTO UNLOCK SYSTEM
-- ============================================================================

local function enableAutoUnlock()
    autoUnlockEnabled = true
    
    if autoUnlockConnection then autoUnlockConnection:Disconnect() end
    
    local function unlockDoors()
        if not autoUnlockEnabled or not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return end
        
        local currentRooms = workspace:FindFirstChild("CurrentRooms")
        if not currentRooms then return end
        
        for _, room in pairs(currentRooms:GetChildren()) do
            if room:IsA("Model") and tonumber(room.Name) then
                local door = room:FindFirstChild("Door")
                if door then
                    local lockPart = door:FindFirstChild("Lock")
                    if lockPart then
                        local prompt = lockPart:FindFirstChildOfClass("ProximityPrompt")
                        if prompt and prompt.Enabled then
                            local distance = (player.Character.HumanoidRootPart.Position - lockPart.Position).Magnitude
                            if distance <= 15 then
                                pcall(function()
                                    fireproximityprompt(prompt)
                                end)
                            end
                        end
                    end
                end
            end
        end
    end
    
    autoUnlockConnection = RunService.Heartbeat:Connect(function()
        unlockDoors()
    end)
    
    print("üîì Advanced Auto Unlock: ENABLED")
end

local function disableAutoUnlock()
    autoUnlockEnabled = false
    
    if autoUnlockConnection then autoUnlockConnection:Disconnect() end
    
    print("üîì Advanced Auto Unlock: DISABLED")
end

-- ============================================================================
-- INFINITE VITAMINS SYSTEM
-- ============================================================================

local function enableInfVitamins()
    infVitaminsEnabled = true
    
    if infVitaminsConnection then infVitaminsConnection:Disconnect() end
    
    local function maintainVitamins()
        if not infVitaminsEnabled or not player.Character then return end
        
        local humanoid = player.Character:FindFirstChild("Humanoid")
        if not humanoid then return end
        
        for _, effect in pairs(humanoid:GetChildren()) do
            if effect:IsA("NumberValue") and effect.Name == "Vitamins" then
                effect.Value = math.huge
            end
        end
        
        if humanoid.Health < humanoid.MaxHealth * 0.8 then
            for _, item in pairs(player.Backpack:GetChildren()) do
                if item.Name == "Vitamins" and item:IsA("Tool") then
                    humanoid:EquipTool(item)
                    task.wait(0.5)
                    if item:FindFirstChild("Handle") then
                        local prompt = item.Handle:FindFirstChildOfClass("ProximityPrompt")
                        if prompt then
                            fireproximityprompt(prompt)
                        end
                    end
                    break
                end
            end
        end
    end
    
    infVitaminsConnection = RunService.Heartbeat:Connect(function()
        maintainVitamins()
    end)
    
    print("üíä Infinite Vitamins: ENABLED")
end

local function disableInfVitamins()
    infVitaminsEnabled = false
    
    if infVitaminsConnection then infVitaminsConnection:Disconnect() end
    
    print("üíä Infinite Vitamins: DISABLED")
end

-- ============================================================================
-- MAIN FUNCTIONS
-- ============================================================================

local function setSpeed(speed)
    currentSpeed = speed
    if player.Character and player.Character:FindFirstChild("Humanoid") then
        player.Character.Humanoid.WalkSpeed = speed
    end
end

local function enableGodMode()
    godModeEnabled = true
    
    for _, conn in pairs(godModeConnections) do
        pcall(function() conn:Disconnect() end)
    end
    godModeConnections = {}
    
    local function maintainGodMode()
        if not godModeEnabled or not player.Character then return end
        
        local humanoid = player.Character:FindFirstChild("Humanoid")
        if humanoid then
            humanoid.MaxHealth = math.huge
            humanoid.Health = math.huge
            
            for _, child in pairs(player.Character:GetChildren()) do
                if child:IsA("BasePart") then
                    child:SetAttribute("OriginalCanTouch", child.CanTouch)
                    child.CanTouch = false
                end
            end
        end
    end
    
    local conn1 = RunService.Heartbeat:Connect(maintainGodMode)
    table.insert(godModeConnections, conn1)
    
    print("üõ°Ô∏è Advanced God Mode: ENABLED")
end

local function disableGodMode()
    godModeEnabled = false
    
    for _, conn in pairs(godModeConnections) do
        pcall(function() conn:Disconnect() end)
    end
    godModeConnections = {}
    
    if player.Character then
        local humanoid = player.Character:FindFirstChild("Humanoid")
        if humanoid then
            humanoid.MaxHealth = 100
            humanoid.Health = 100
        end
        
        for _, child in pairs(player.Character:GetChildren()) do
            if child:IsA("BasePart") and child:GetAttribute("OriginalCanTouch") ~= nil then
                child.CanTouch = child:GetAttribute("OriginalCanTouch")
            end
        end
    end
    
    print("üõ°Ô∏è Advanced God Mode: DISABLED")
end

local function enableNoclip()
    noclipEnabled = true
    
    if noclipConnection then noclipConnection:Disconnect() end
    
    noclipConnection = RunService.Stepped:Connect(function()
        if noclipEnabled and player.Character then
            for _, part in pairs(player.Character:GetDescendants()) do
                if part:IsA("BasePart") and part.Name ~= "HumanoidRootPart" then
                    part.CanCollide = false
                end
            end
        end
    end)
    
    print("üëª Advanced Noclip: ENABLED")
end

local function disableNoclip()
    noclipEnabled = false
    
    if noclipConnection then noclipConnection:Disconnect() end
    
    if player.Character then
        for _, part in pairs(player.Character:GetDescendants()) do
            if part:IsA("BasePart") and part.Name ~= "HumanoidRootPart" then
                part.CanCollide = true
            end
        end
    end
    
    print("üëª Advanced Noclip: DISABLED")
end

local function enableBypassAntiCheat()
    bypassAntiCheat = true
    
    for _, conn in pairs(bypassConnections) do
        pcall(function() conn:Disconnect() end)
    end
    bypassConnections = {}
    
    local mt = getrawmetatable(game)
    local oldNamecall = mt.__namecall
    
    setreadonly(mt, false)
    mt.__namecall = function(self, ...)
        local method = getnamecallmethod()
        local args = {...}
        
        if method == "FireServer" or method == "InvokeServer" then
            local remoteName = tostring(self)
            if remoteName:find("Anti") or remoteName:find("Kick") or remoteName:find("Ban") then
                return
            end
        end
        
        return oldNamecall(self, ...)
    end
    setreadonly(mt, true)
    
    print("üõ°Ô∏è Bypass Anti-Cheat: ENABLED")
end

local function disableBypassAntiCheat()
    bypassAntiCheat = false
    
    for _, conn in pairs(bypassConnections) do
        pcall(function() conn:Disconnect() end)
    end
    bypassConnections = {}
    
    print("üõ°Ô∏è Bypass Anti-Cheat: DISABLED")
end

-- Apply settings on character spawn
player.CharacterAdded:Connect(function(character)
    wait(1)
    if character:FindFirstChild("Humanoid") then
        character.Humanoid.WalkSpeed = currentSpeed
        if godModeEnabled then
            enableGodMode()
        end
        if noclipEnabled then
            enableNoclip()
        end
    end
end)

-- ============================================================================
-- MAIN RAYFIELD UI WITH SMART KEYBIND INTEGRATION
-- ============================================================================

task.spawn(function()
    wait(10) -- Wait for all loading screens
    
    -- Create smart draggable toggle button
    ToggleButton = createSmartDraggableToggleButton()
    
    -- Setup keybind detection
    setupSmartKeybindDetection()
    
    local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
    
    -- Hook into Rayfield to detect keybind
    local originalCreateWindow = Rayfield.CreateWindow
    Rayfield.CreateWindow = function(settings)
        local window = originalCreateWindow(settings)
        
        -- Try to extract keybind from window
        task.spawn(function()
            wait(3)
            
            -- Check for keybind in window properties
            if window and window.KeybindFrame then
                local keybindText = window.KeybindFrame:FindFirstChild("Text")
                if keybindText then
                    local detectedKey = keybindText.Text:upper()
                    if detectedKey:len() == 1 and detectedKey ~= currentKeybind then
                        currentKeybind = detectedKey
                        if ToggleButton and ToggleButton.UpdateKeybind then
                            ToggleButton.UpdateKeybind(detectedKey)
                        end
                        if PermanentLogo and PermanentLogo.UpdateKeybind then
                            PermanentLogo.UpdateKeybind(detectedKey)
                        end
                        print("üîç Window-detected keybind: " .. detectedKey)
                    end
                end
            end
            
            -- Check settings if available
            if settings and settings.KeySettings and settings.KeySettings.Toggle then
                local keybind = tostring(settings.KeySettings.Toggle):upper()
                if keybind and keybind:len() == 1 and keybind ~= currentKeybind then
                    currentKeybind = keybind
                    if ToggleButton and ToggleButton.UpdateKeybind then
                        ToggleButton.UpdateKeybind(keybind)
                    end
                    if PermanentLogo and PermanentLogo.UpdateKeybind then
                        PermanentLogo.UpdateKeybind(keybind)
                    end
                    print("üîç Settings-detected keybind: " .. keybind)
                end
            end
        end)
        
        return window
    end
    
    MainWindow = Rayfield:CreateWindow({
        Name = "Wener Hub v4.0 - Complete Smart Keybind",
        LoadingTitle = "Complete Smart Toggle System",
        LoadingSubtitle = "All features + Smart keybind detection",
        ConfigurationSaving = {
            Enabled = true,
            FolderName = "WenerHub", 
            FileName = "Config"
        },
        Discord = {
            Enabled = false
        },
        KeySystem = false
    })
    
    -- Create all tabs
    local InfoTab = MainWindow:CreateTab("üìã Smart Info", 4483362458)
    local MainTab = MainWindow:CreateTab("‚öôÔ∏è Main Features", 4483362458)
    local ESPTab = MainWindow:CreateTab("üëÅÔ∏è Fixed ESP", 4483362458)
    local AutoTab = MainWindow:CreateTab("ü§ñ Automation", 4483362458)
    local NotifTab = MainWindow:CreateTab("üîî Notifications", 4483362458)
    local KeybindTab = MainWindow:CreateTab("üéõÔ∏è Smart Keybind", 4483362458)
    local MiscTab = MainWindow:CreateTab("üîß Miscellaneous", 4483362458)
    
    -- Info Tab
    InfoTab:CreateParagraph({
        Title = "üéõÔ∏è Smart Draggable Toggle Button", 
        Content = "‚ú® Purple circular button with smart keybind detection!\nüîç Auto-detects Rayfield keybind: (K), (E), (P), etc.\nüñ±Ô∏è Drag anywhere, click infinite times\nüì± Mobile & desktop compatible\nüéØ Smart key simulation based on detected keybind\nüîÑ Real-time keybind monitoring"
    })
    
    InfoTab:CreateParagraph({
        Title = "üöÄ COMPLETE FEATURE LIST", 
        Content = "‚úÖ Smart keybind detection & adaptation\n‚úÖ Fixed ESP system with size stability\n‚úÖ Advanced automation (auto collect, unlock, vitamins)\n‚úÖ Entity notifications with sound\n‚úÖ God mode, noclip, speed controls\n‚úÖ Anti-cheat bypass\n‚úÖ Auto execute & reconnect\n‚úÖ Permanent logo with owner detection"
    })
    
    InfoTab:CreateParagraph({
        Title = "üë§ Player Information", 
        Content = "Username: " .. player.Name .. 
                  "\nDisplay Name: " .. player.DisplayName .. 
                  "\nUser ID: " .. player.UserId ..
                  "\nCurrent Keybind: " .. currentKeybind ..
                  (isOwner and "\n\nüëë OWNER ACCESS GRANTED" or "")
    })
    
    -- Main Features Tab
    MainTab:CreateSlider({
        Name = "‚ö° Speed Multiplier",
        Range = {1, 6},
        Increment = 0.1,
        Suffix = "x",
        CurrentValue = 1,
        Flag = "SpeedSlider",
        Callback = function(v) 
            setSpeed(16 * v)
        end
    })
    
    MainTab:CreateToggle({
        Name = "üõ°Ô∏è Advanced God Mode",
        CurrentValue = false,
        Flag = "GodMode",
        Callback = function(v)
            if v then
                enableGodMode()
            else
                disableGodMode()
            end
        end
    })
    
    MainTab:CreateToggle({
        Name = "üîì Bypass Anti-Cheat",
        CurrentValue = false,
        Flag = "BypassAntiCheat",
        Callback = function(v)
            if v then
                enableBypassAntiCheat()
            else
                disableBypassAntiCheat()
            end
        end
    })
    
    MainTab:CreateToggle({
        Name = "üëª Advanced Noclip",
        CurrentValue = false,
        Flag = "Noclip",
        Callback = function(v)
            if v then
                enableNoclip()
            else
                disableNoclip()
            end
        end
    })
    
    MainTab:CreateButton({
        Name = "üîÑ Respawn Character",
        Callback = function()
            if player.Character then
                player.Character:BreakJoints()
            end
        end
    })
    
    MainTab:CreateButton({
        Name = "üö™ Teleport to Latest Room",
        Callback = function()
            local currentRooms = workspace:FindFirstChild("CurrentRooms")
            if currentRooms and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                local latestRoom = nil
                local highestNumber = 0
                
                for _, room in pairs(currentRooms:GetChildren()) do
                    local roomNumber = tonumber(room.Name)
                    if roomNumber and roomNumber > highestNumber then
                        highestNumber = roomNumber
                        latestRoom = room
                    end
                end
                
                if latestRoom then
                    local roomPos = latestRoom:FindFirstChildWhichIsA("BasePart")
                    if roomPos then
                        player.Character.HumanoidRootPart.CFrame = CFrame.new(roomPos.Position + Vector3.new(0, 5, 0))
                    end
                end
            end
        end
    })
    
    -- Fixed ESP Tab
    ESPTab:CreateLabel("‚ú® FIXED ESP SYSTEM - Size tetap saat zoom!")
    
    ESPTab:CreateToggle({
        Name = "üö™ Door ESP (Green Outline)",
        CurrentValue = false,
        Flag = "DoorESP",
        Callback = function(v)
            doorEspEnabled = v
            if not v then 
                clearAllESP() 
            else
                updateDoorESP()
            end
        end
    })
    
    ESPTab:CreateToggle({
        Name = "üóùÔ∏è Key ESP (Yellow Outline) - FIXED",
        CurrentValue = false,
        Flag = "KeyESP",
        Callback = function(v)
            keyEspEnabled = v
            if not v then 
                clearAllESP() 
            else
                updateKeyESP()
            end
        end
    })
    
    ESPTab:CreateToggle({
        Name = "üì¶ Item ESP (Red Outline) - Collectable Only",
        CurrentValue = false,
        Flag = "ItemESP",
        Callback = function(v)
            itemEspEnabled = v
            if not v then 
                clearAllESP() 
            else
                updateItemESP()
            end
        end
    })
    
    ESPTab:CreateToggle({
        Name = "üìö Book ESP (Brown Outline) - Figure Books",
        CurrentValue = false,
        Flag = "BookESP",
        Callback = function(v)
            bookEspEnabled = v
            if not v then 
                clearAllESP() 
            else
                updateBookESP()
            end
        end
    })
    
    ESPTab:CreateToggle({
        Name = "üëπ Entity ESP (All Monsters)",
        CurrentValue = false,
        Flag = "EntityESP",
        Callback = function(v)
            entityEspEnabled = v
            if not v then 
                clearAllESP() 
            else
                updateEntityESP()
            end
        end
    })
    
    ESPTab:CreateToggle({
        Name = "üë§ Player ESP",
        CurrentValue = false,
        Flag = "PlayerESP",
        Callback = function(v)
            playerEspEnabled = v
            if not v then 
                clearAllESP() 
            else
                updatePlayerESP()
            end
        end
    })
    
    ESPTab:CreateButton({
        Name = "üîÑ Refresh All ESP",
        Callback = function()
            clearAllESP()
            if doorEspEnabled then updateDoorESP() end
            if keyEspEnabled then updateKeyESP() end
            if itemEspEnabled then updateItemESP() end
            if bookEspEnabled then updateBookESP() end
            if entityEspEnabled then updateEntityESP() end
            if playerEspEnabled then updatePlayerESP() end
        end
    })
    
    ESPTab:CreateButton({
        Name = "üóëÔ∏è Clear All ESP",
        Callback = function()
            doorEspEnabled = false
            keyEspEnabled = false
            entityEspEnabled = false
            playerEspEnabled = false
            bookEspEnabled = false
                itemEspEnabled = false
            clearAllESP()
            Rayfield:Notify({
                Title = "üóëÔ∏è ESP Cleared",
                Content = "All ESP objects have been removed",
                Duration = 3,
                Image = 4483362458,
            })
        end
    })
    
    -- Automation Tab
    AutoTab:CreateLabel("ü§ñ ADVANCED AUTOMATION FEATURES")
    
    AutoTab:CreateToggle({
        Name = "üì¶ Auto Collect Items",
        CurrentValue = false,
        Flag = "AutoCollect",
        Callback = function(v)
            if v then
                enableAutoCollect()
            else
                disableAutoCollect()
            end
        end
    })
    
    AutoTab:CreateSection("üì¶ Auto Collect Settings")
    
    local collectableItems = {"Vitamins", "Lockpick", "Key", "Flashlight", "Lighter", "Candle", "Crucifix", "Bandage", "SkeletonKey", "Book"}
    
    for _, itemName in pairs(collectableItems) do
        AutoTab:CreateToggle({
            Name = "üîπ Collect " .. itemName,
            CurrentValue = true,
            Flag = "Collect" .. itemName,
            Callback = function(v)
                autoCollectSettings[itemName] = v
                print("üì¶ Auto Collect " .. itemName .. ": " .. (v and "ENABLED" or "DISABLED"))
            end
        })
    end
    
    AutoTab:CreateToggle({
        Name = "üîì Auto Unlock Doors",
        CurrentValue = false,
        Flag = "AutoUnlock",
        Callback = function(v)
            if v then
                enableAutoUnlock()
            else
                disableAutoUnlock()
            end
        end
    })
    
    AutoTab:CreateToggle({
        Name = "üíä Infinite Vitamins",
        CurrentValue = false,
        Flag = "InfVitamins",
        Callback = function(v)
            if v then
                enableInfVitamins()
            else
                disableInfVitamins()
            end
        end
    })
    
    -- Notifications Tab
    NotifTab:CreateLabel("üîî ADVANCED NOTIFICATION SYSTEM")
    
    NotifTab:CreateToggle({
        Name = "‚ö° Rush/Ambush Notifications",
        CurrentValue = false,
        Flag = "RushNotif",
        Callback = function(v)
            rushNotifEnabled = v
            setupEntityNotifications()
        end
    })
    
    NotifTab:CreateToggle({
        Name = "üëπ All Entity Notifications",
        CurrentValue = false,
        Flag = "AllEntityNotif",
        Callback = function(v)
            allEntityNotifications = v
            setupEntityNotifications()
        end
    })
    
    NotifTab:CreateButton({
        Name = "üß™ Test Notification System",
        Callback = function()
            createAdvancedNotification(
                "üß™ TEST NOTIFICATION",
                "This is a test of the advanced notification system with sound and animations!",
                Color3.fromRGB(0, 255, 0),
                4,
                true
            )
        end
    })
    
    -- Smart Keybind Tab
    KeybindTab:CreateLabel("üéõÔ∏è SMART KEYBIND DETECTION SYSTEM")
    
    local currentKeybindLabel = KeybindTab:CreateLabel("Current Detected Keybind: " .. currentKeybind)
    local detectionStatus = KeybindTab:CreateLabel("üîç Status: Auto-detecting...")
    
    KeybindTab:CreateParagraph({
        Title = "üîç Auto Detection Methods",
        Content = "Method 1: Rayfield UI element scanning\nMethod 2: Window property monitoring\nMethod 3: Settings extraction\nMethod 4: Input pattern analysis\nMethod 5: Storage value checking"
    })
    
    KeybindTab:CreateDropdown({
        Name = "üîß Manual Keybind Override",
        Options = {"K", "E", "P", "M", "N", "B", "V", "X", "Z", "C", "F", "G", "H", "J", "L", "O", "Q", "R", "T", "U", "Y", "I"},
        CurrentOption = currentKeybind,
        Flag = "ManualKeybind",
        Callback = function(Option)
            currentKeybind = Option
            if ToggleButton and ToggleButton.UpdateKeybind then
                ToggleButton.UpdateKeybind(Option)
            end
            if PermanentLogo and PermanentLogo.UpdateKeybind then
                PermanentLogo.UpdateKeybind(Option)
            end
            currentKeybindLabel.Set("Current Keybind: " .. Option)
            detectionStatus.Set("üîß Manual Override: " .. Option)
            print("üîß Manual keybind override: " .. Option)
        end
    })
    
    KeybindTab:CreateButton({
        Name = "üîÑ Reset to Auto-Detection",
        Callback = function()
            detectionStatus.Set("üîç Status: Auto-detecting...")
            setupSmartKeybindDetection()
        end
    })
    
    KeybindTab:CreateButton({
        Name = "üß™ Test Current Keybind",
        Callback = function()
            local keyCode = Enum.KeyCode[currentKeybind] or Enum.KeyCode.K
            game:GetService("VirtualInputManager"):SendKeyEvent(true, keyCode, false, game)
            task.wait(0.1)
            game:GetService("VirtualInputManager"):SendKeyEvent(false, keyCode, false, game)
            
            detectionStatus.Set("üß™ Tested: " .. currentKeybind .. " key simulated!")
            
            task.wait(3)
            detectionStatus.Set("üîç Current: " .. currentKeybind)
        end
    })
    
    KeybindTab:CreateButton({
        Name = "üéõÔ∏è Show Toggle Button Info",
        Callback = function()
            Rayfield:Notify({
                Title = "üéõÔ∏è Smart Toggle Button",
                Content = "Look for the purple circular button!\nKeybind: " .. currentKeybind .. "\nDrag to move, click to toggle",
                Duration = 5,
                Image = 4483362458,
            })
        end
    })
    
    -- Miscellaneous Tab
    MiscTab:CreateLabel("üîß MISCELLANEOUS FEATURES")
    
    MiscTab:CreateButton({
        Name = "üìã Copy Script to Clipboard",
        Callback = function()
            local scriptCode = 'loadstring(game:HttpGet("https://raw.githubusercontent.com/WanerScripts/WenerHub/main/doors-ultimate-smart.lua"))()'
            if setclipboard then
                setclipboard(scriptCode)
                Rayfield:Notify({
                    Title = "üìã Copied!",
                    Content = "Script code copied to clipboard",
                    Duration = 3,
                    Image = 4483362458,
                })
            end
        end
    })
    
    MiscTab:CreateButton({
        Name = "üöÄ Enable Auto Execute",
        Callback = function()
            setupAutoExecute()
            Rayfield:Notify({
                Title = "üöÄ Auto Execute",
                Content = "Auto execute has been configured",
                Duration = 3,
                Image = 4483362458,
            })
        end
    })
    
    MiscTab:CreateButton({
        Name = "üì± Create Mobile GUI",
        Callback = function()
            -- Create additional mobile-friendly GUI
            local MobileGui = Instance.new("ScreenGui")
            MobileGui.Name = "WenerMobileGUI"
            MobileGui.ResetOnSpawn = false
            MobileGui.Parent = game.CoreGui
            
            local MobileFrame = Instance.new("Frame")
            MobileFrame.Size = UDim2.new(0, 300, 0, 200)
            MobileFrame.Position = UDim2.new(0, 10, 0.5, -100)
            MobileFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 25)
            MobileFrame.Parent = MobileGui
            
            local Corner = Instance.new("UICorner")
            Corner.CornerRadius = UDim.new(0, 15)
            Corner.Parent = MobileFrame
            
            local Title = Instance.new("TextLabel")
            Title.Size = UDim2.new(1, 0, 0, 40)
            Title.BackgroundTransparency = 1
            Title.Text = "üì± WENER MOBILE"
            Title.TextColor3 = Color3.fromRGB(255, 255, 255)
            Title.Font = Enum.Font.GothamBold
            Title.TextSize = 18
            Title.Parent = MobileFrame
            
            local quickButtons = {
                {name = "Speed x3", callback = function() setSpeed(48) end},
                {name = "God Mode", callback = function() enableGodMode() end},
                {name = "Noclip", callback = function() enableNoclip() end},
                {name = "ESP All", callback = function() 
                    doorEspEnabled = true
                    keyEspEnabled = true
                    updateDoorESP()
                    updateKeyESP()
                end}
            }
            
            for i, buttonData in pairs(quickButtons) do
                local QuickButton = Instance.new("TextButton")
                QuickButton.Size = UDim2.new(0.45, 0, 0, 30)
                QuickButton.Position = UDim2.new(
                    (i-1) % 2 == 0 and 0.05 or 0.5, 0, 
                    0, 50 + math.floor((i-1) / 2) * 35
                )
                QuickButton.BackgroundColor3 = Color3.fromRGB(139, 0, 255)
                QuickButton.Text = buttonData.name
                QuickButton.TextColor3 = Color3.fromRGB(255, 255, 255)
                QuickButton.Font = Enum.Font.Gotham
                QuickButton.TextSize = 12
                QuickButton.Parent = MobileFrame
                
                local ButtonCorner = Instance.new("UICorner")
                ButtonCorner.CornerRadius = UDim.new(0, 8)
                ButtonCorner.Parent = QuickButton
                
                QuickButton.MouseButton1Click:Connect(buttonData.callback)
            end
            
            Rayfield:Notify({
                Title = "üì± Mobile GUI Created",
                Content = "Additional mobile controls added",
                Duration = 3,
                Image = 4483362458,
            })
        end
    })
    
    if isOwner then
        MiscTab:CreateSection("üëë OWNER EXCLUSIVE")
        
        MiscTab:CreateButton({
            Name = "üëë Owner Broadcast",
            Callback = function()
                for _, otherPlayer in pairs(Players:GetPlayers()) do
                    if otherPlayer ~= player then
                        createAdvancedNotification(
                            "üëë OWNER MESSAGE",
                            "WENER HUB v4.0 by " .. player.DisplayName .. " is active!",
                            Color3.fromRGB(255, 215, 0),
                            8,
                            true
                        )
                    end
                end
            end
        })
        
        MiscTab:CreateButton({
            Name = "üõ†Ô∏è Debug Keybind Detection",
            Callback = function()
                print("üîç === KEYBIND DEBUG INFO ===")
                print("Current Keybind:", currentKeybind)
                print("Rayfield UI Found:", game.CoreGui:FindFirstChild("Rayfield") ~= nil)
                print("Toggle Button Active:", ToggleButton ~= nil)
                print("Permanent Logo Active:", PermanentLogo ~= nil)
                
                local rayfield = game.CoreGui:FindFirstChild("Rayfield")
                if rayfield then
                    print("Rayfield Elements:")
                    for _, obj in pairs(rayfield:GetDescendants()) do
                        if obj:IsA("TextLabel") and obj.Text:find("[A-Z]") then
                            print(" - " .. obj.Name .. ": " .. obj.Text)
                        end
                    end
                end
                print("üîç === END DEBUG INFO ===")
            end
        })
    end
    
    -- Start periodic ESP updates
    task.spawn(function()
        while true do
            wait(2)
            if doorEspEnabled then updateDoorESP() end
            if keyEspEnabled then updateKeyESP() end
            if itemEspEnabled then updateItemESP() end
            if bookEspEnabled then updateBookESP() end
            if entityEspEnabled then updateEntityESP() end
            if playerEspEnabled then updatePlayerESP() end
        end
    end)
    
    -- Update keybind status periodically
    task.spawn(function()
        while true do
            wait(5)
            if currentKeybindLabel and currentKeybindLabel.Set then
                currentKeybindLabel.Set("Current Keybind: " .. currentKeybind)
            end
            if detectionStatus and detectionStatus.Set and not detectionStatus.Text:find("Manual") and not detectionStatus.Text:find("Tested") then
                detectionStatus.Set("üîç Monitoring: " .. currentKeybind)
            end
        end
    end)
    
    -- Try to detect Rayfield's actual keybind after full load
    task.spawn(function()
        wait(5)
        
        -- Final keybind detection attempt
        local rayfield_ui = game.CoreGui:FindFirstChild("Rayfield")
        if rayfield_ui then
            print("üîç Final keybind detection scan...")
            
            for _, obj in pairs(rayfield_ui:GetDescendants()) do
                if obj:IsA("TextLabel") then
                    local text = obj.Text:upper()
                    local possibleKeys = {"K", "E", "P", "M", "N", "B", "V", "X", "Z", "C", "F", "G", "H", "J", "L", "O"}
                    
                    for _, key in pairs(possibleKeys) do
                        if text:find("PRESS " .. key) or text:find("KEY " .. key) or (text == key and obj.Name:find("Key")) then
                            if key ~= currentKeybind then
                                currentKeybind = key
                                if ToggleButton and ToggleButton.UpdateKeybind then
                                    ToggleButton.UpdateKeybind(key)
                                end
                                if PermanentLogo and PermanentLogo.UpdateKeybind then
                                    PermanentLogo.UpdateKeybind(key)
                                end
                                if currentKeybindLabel and currentKeybindLabel.Set then
                                    currentKeybindLabel.Set("Current Keybind: " .. key)
                                end
                                if detectionStatus and detectionStatus.Set then
                                    detectionStatus.Set("üîç Auto-detected: " .. key)
                                end
                                print("üîç Final scan detected keybind: " .. key)
                            end
                            break
                        end
                    end
                end
            end
        end
    end)
    
    -- Final success notification
    Rayfield:Notify({
        Title = "üéõÔ∏è COMPLETE WENER HUB LOADED!",
        Content = "Smart keybind: " .. currentKeybind .. " | All features active!",
        Duration = 8,
        Image = 4483362458,
    })
    
    print("‚úÖ === WENER HUB v4.0 COMPLETE WITH SMART KEYBIND FULLY LOADED! ===")
    print("üéõÔ∏è Smart draggable button created with keybind: " .. currentKeybind)
    print("üîç Advanced keybind detection system active!")
    print("üìä All features loaded: ESP, Automation, Notifications, etc.")
    print("üîÑ Button text shows current keybind and simulates correct key!")
    print("‚ôæÔ∏è Infinite clicks with real-time keybind monitoring!")
end)

print("‚úÖ WENER HUB v4.0 COMPLETE SMART KEYBIND SYSTEM INITIALIZED!")
print("üéõÔ∏è Look for purple button that shows current keybind!")
print("üîç Button automatically detects and adapts to Rayfield keybind changes!")
print("üìã COMPLETE FEATURE LIST:")
print("   ‚úÖ Smart keybind detection with 5 methods")
print("   ‚úÖ Draggable toggle button with keybind display")  
print("   ‚úÖ Fixed ESP system (stable size)")
print("   ‚úÖ Advanced automation (collect, unlock, vitamins)")
print("   ‚úÖ Entity notifications with sound")
print("   ‚úÖ God mode, noclip, speed controls")
print("   ‚úÖ Anti-cheat bypass")
print("   ‚úÖ Auto execute & reconnect")
print("   ‚úÖ Permanent logo with owner detection")
print("   ‚úÖ Mobile GUI support")
print("   ‚úÖ Complete Doors features")
print("=" .. string.rep("=", 80) .. "=")
print("WENER HUB v4.0 - COMPLETE WITH SMART KEYBIND DETECTION")
print("The most advanced Doors script with intelligent keybind adaptation!")
print("Button shows: (K), (E), (P), etc. based on your Rayfield keybind")
print("Infinite clicks + Real-time monitoring + Complete automation!")
print("=" .. string.rep("=", 80) .. "=")
